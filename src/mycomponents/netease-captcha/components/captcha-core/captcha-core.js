require("./../../runtime"),require("./../../common"),(my.neCaptchaJsonp=my.neCaptchaJsonp||[]).push([[3],{19:function(t,a,e){"use strict";var i,n,s=Object.assign||function(t){for(var a=1;a<arguments.length;a++){var e=arguments[a];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},o=T(e(1)),r=e(0),c=e(2),h=T(c),u=T(e(10)),d=T(e(6)),p=T(e(4)),f=T(e(11)),l=e(5);function T(t){return t&&t.__esModule?t:{default:t}}function I(t){return function(){var a=t.apply(this,arguments);return new Promise((function(t,e){return function i(n,s){try{var o=a[n](s),r=o.value}catch(t){return void e(t)}if(!o.done)return Promise.resolve(r).then((function(t){i("next",t)}),(function(t){i("throw",t)}));t(r)}("next")}))}}Component({mixins:[p.default],props:{visible:!1,onInit:function(){},onClose:function(){},onClosed:function(){},onReady:function(){},onCoreError:function(){},onVerify:function(){}},data:{CAPTCHA_TYPE:r.CAPTCHA_TYPE,VERIFY_STATUS:r.VERIFY_STATUS,minWidth:r.WIDTH_RANGE[0],modalAnimationData:{},maskOpacity:0,popupVisible:!1,captchaType:"",loadInfo:{status:"loading",data:null},countsOfVerifyError:0,verifyStatus:"",captchaTip:"",theme:"",width:0,isReady:!1,isFromInit:!1,widthIsNotAuto:!1,popWidth:""},onInit:function(){var t=my.createAnimation();this.modalAnimation=t},didUpdate:function(t){var a=this.props.visible;a!==t.visible&&this.toggleVisible(a)},didMount:function(){var t=this;this.initData(),this.setData({isFromInit:!0}),this.props.onInit(),this.unsubscribeStore=this.store.subscribe((function(a,e){"UPDATE_TYPE"===a.type&&t.setData({captchaType:e.captchaType})}))},didUnmount:function(){this.unsubscribeStore()},methods:{initData:function(){var t=this.store.state,a=t.config,e=t.customStyles,i=t.$fetch;if(!a)throw new h.default(c.CONFIG_ERROR,"[core] config must not be null");var n=a.theme,s="auto"!==e.width;this.setData({config:a,theme:n,customStyles:e,widthIsNotAuto:s,popWidth:s?e.width+"px":"auto"}),this.$fetch=i},toggleVisible:function(t){var a=this;if(t)this.setData({popupVisible:t}),!this.data.isFromInit&&this.store.state.token||this.reset(),setTimeout((function(){a.modalAnimation.opacity(1).translateY(0).step({duration:300,timingFunction:"linear"}),a.setData({modalAnimationData:a.modalAnimation.export(),maskOpacity:.3}),a.store.commit("UPDATE_VISIBLE",t)}),30);else{this.modalAnimation.opacity(0).translateY(-40).step({duration:200,timingFunction:"ease-out"}),this.setData({modalAnimationData:this.modalAnimation.export(),maskOpacity:0}),setTimeout((function(){a.setData({popupVisible:t}),a.props.onClosed(),a.store.commit("UPDATE_VISIBLE",t)}),200)}},reset:function(){this.setData({loadInfo:{status:"done",data:null},countsOfVerifyError:0,verifyStatus:"",captchaTip:"",isFromInit:!1}),this.refresh()},resetIfNeed:function(){var t=this.data,a=t.countsOfVerifyError,e=t.verifyStatus;a>r.MAX_VERIFICATION&&e===r.VERIFY_STATUS.MAX_ERROR&&this.reset()},refresh:function(){var t={verifyStatus:"",token:this.store.state.token};this.fetchCaptcha(t)},fetchCaptcha:(n=I(o.default.mark((function t(a){var e,i,n,s,p,f,l,T,I,E,m,A,y=this;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.data.langPkg,this.setData({verifyStatus:"",loadInfo:{status:"loading",data:null},captchaTip:e.LOADING}),i=this.data.config,n=i.captchaId,s=i.captchaType,p=this.store.state,f=p.drp,l=p.token,T=Object.assign({id:n,https:!0,type:s,version:"1.0.1",drp:f,token:l,dev:r.DEVICE_TYPE.TOUCH,cb:(0,u.default)(),width:this.data.width,runEnv:r.RUNENV},a),I="/api/v2/mp/get",t.prev=6,t.next=9,this.$fetch({url:I,data:T,onTryError:(0,d.default)(this.data.config)});case 9:E=t.sent,m=E.data,this.setData({loadInfo:{status:"loading",data:m}}),this.store.commit("UPDATE_TOKEN",{token:m.token}),this.store.commit("UPDATE_TYPE",{captchaType:m.type}),t.next=21;break;case 16:t.prev=16,t.t0=t.catch(6),A=new h.default(c.REQUEST_API_ERROR,t.t0.message,{url:I}),this.setData({loadInfo:{status:"error",data:null},captchaTip:e.LOAD_FAIL}),this.catchError(A);case 21:this.data.width||my.createSelectorQuery().select(".query-wrap-"+this.data.uuid).boundingClientRect().exec((function(t){var a=t[0];y.setData({width:a.width})}));case 22:case"end":return t.stop()}}),t,this,[[6,16]])}))),function(t){return n.apply(this,arguments)}),finishLoad:function(t){var a=t?"error":"done",e=void 0;if(t)e=this.data.langPkg.LOAD_FAIL;else switch(this.store.state.captchaType){case r.CAPTCHA_TYPE.JIGSAW:e=this.data.langPkg.SLIDE_TIP;break;case r.CAPTCHA_TYPE.POINT:case r.CAPTCHA_TYPE.ICON_POINT:e=this.data.langPkg.CLICK_IN_TURN;break;default:e=""}this.setData({loadInfo:s({},this.data.loadInfo,{status:a}),captchaTip:e}),"error"===a&&this.catchError(t),"done"!==a||this.data.isReady||(this.setData({isReady:!0}),this.props.onReady("ready"))},catchError:function(t){this.props.onCoreError(t)},onVerifyCaptcha:function(t){var a=this.data.width,e=this.store.state.token,i=t.data,n=t.type;this.verifyCaptcha(s({token:e,width:a,type:n},i))},verifyCaptcha:(i=I(o.default.mark((function t(a){var e,i,n,s,p,T,I,E,m=this;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setData({verifyStatus:r.VERIFY_STATUS.DOING}),e=this.store.state.captchaType,i="/api/v2/mp/check",n=function(t){var n=m.data.countsOfVerifyError+1,s="";n>r.MAX_VERIFICATION?s=m.data.langPkg.VERIFY_OUT_OF_LIMIT:e!==r.CAPTCHA_TYPE.JIGSAW&&(s=m.data.langPkg.VERIFY_ERROR),m.setData({countsOfVerifyError:n,verifyStatus:n>r.MAX_VERIFICATION?r.VERIFY_STATUS.MAX_ERROR:r.VERIFY_STATUS.ERROR,captchaTip:s});var o=null;o=t?new h.default(c.REQUEST_API_ERROR,t.message,{url:i,token:a?a.token:""}):new h.default(c.BUSINESS_ERROR,"Failed to verify captcha.",{url:i}),m.props.onVerify([o]),n<=r.MAX_VERIFICATION&&setTimeout((function(){m.refresh()}),[r.CAPTCHA_TYPE.POINT,r.CAPTCHA_TYPE.ICON_POINT].includes(e)?1200:300)},s=this.data.config.captchaId,p=Object.assign({},{id:s,version:"1.0.1",cb:(0,u.default)(),runEnv:r.RUNENV},a),t.prev=6,t.next=9,this.$fetch({url:i,method:"POST",data:p,onTryError:(0,d.default)(this.data.config,{token:p.token})});case 9:T=t.sent,(I=T.data).result?(this.setData({verifyStatus:r.VERIFY_STATUS.SUCCESS,captchaTip:e===r.CAPTCHA_TYPE.JIGSAW?"":this.data.langPkg.VERIFY_SUCCESS}),E=(0,f.default)((0,l.eypt)(I.validate+"::")),this.props.onVerify([null,E]),this.closeDialog()):n(),t.next=17;break;case 14:t.prev=14,t.t0=t.catch(6),n(t.t0);case 17:case"end":return t.stop()}}),t,this,[[6,14]])}))),function(t){return i.apply(this,arguments)}),closeDialog:function(){this.props.onClose()}}})}},[[19,1,0]]]);